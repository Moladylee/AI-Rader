name: Sync Upstream via PR
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 10 * * *' # æ¯å‘¨ä¸€UTCæ—¶é—´3ç‚¹è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºæ‚¨è‡ªå·±ä»“åº“çš„ä»£ç 
      - name: Checkout Your Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´å†å²

      # 2. é…ç½®Gitèº«ä»½
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 3. æ‹‰å–ä¸Šæ¸¸ä»“åº“çš„æ›´æ–°åˆ°å½“å‰å·¥ä½œåŒº
      - name: Pull Upstream Changes
        run: |
          git remote add upstream https://github.com/sansan0/TrendRadar.git 2>/dev/null || true
          git fetch upstream
          # å°†ä¸Šæ¸¸ master åˆ†æ”¯åˆå¹¶åˆ°å½“å‰å·¥ä½œåŒº
          git merge upstream/master --allow-unrelated-histories --no-edit --strategy-option theirs
          echo "âœ… ä¸Šæ¸¸æ›´æ–°å·²æ‹‰å–å¹¶åˆå¹¶åˆ°å·¥ä½œåŒºã€‚"

      # 4. ä¿æŠ¤æ‚¨çš„é…ç½®æ–‡ä»¶ï¼ˆç”¨æ‚¨ä»“åº“çš„ç‰ˆæœ¬è¦†ç›–ï¼‰
      - name: Protect Local Configs
        run: |
          # å…³é”®ï¼šä»æ‚¨è‡ªå·±ä»“åº“çš„è¿œç¨‹åˆ†æ”¯æ¢å¤æ–‡ä»¶
          # è¯·å°† `master` æ”¹ä¸ºæ‚¨è‡ªå·±ä»“åº“çš„ä¸»åˆ†æ”¯åï¼ˆmain æˆ– masterï¼‰
          git checkout origin/master -- config.yaml frequency_words.txt 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°éƒ¨åˆ†ä¿æŠ¤æ–‡ä»¶ã€‚"
          echo "âœ… å·²æ¢å¤å—ä¿æŠ¤çš„æ–‡ä»¶ (config.yaml, frequency_words.txt)ã€‚"

      - name: Get Current Date
        id: date
        run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      # 5. åˆ›å»º Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync updates from upstream TrendRadar"
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ï¼šä¸Šæ¸¸ TrendRadar æ›´æ–° [${{ env.date }}]"
          body: |
            æ­¤ PR åŒ…å«æ¥è‡ªä¸Šæ¸¸ä»“åº“ [sansan0/TrendRadar](https://github.com/sansan0/TrendRadar) çš„æ›´æ–°ã€‚
            **ä»¥ä¸‹æ–‡ä»¶å·²å—ä¿æŠ¤ï¼Œä¿æŒæ‚¨æœ¬åœ°çš„ç‰ˆæœ¬ï¼š**
            - `config.yaml`
            - `frequency_words.txt`
            è¯·æ£€æŸ¥å…¶ä»–å˜æ›´ååˆå¹¶ã€‚
          branch: auto-sync/trendradar # ç”¨äºPRçš„å›ºå®šåˆ†æ”¯å
          base: master # ğŸš¨é‡è¦ï¼šæ”¹ä¸ºæ‚¨è‡ªå·±ä»“åº“çš„ç›®æ ‡åˆ†æ”¯å
          labels: automated-pr, upstream-sync
          delete-branch: true
