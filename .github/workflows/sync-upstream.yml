name: Sync Upstream via PR
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 3 * * 1' # æ¯å‘¨ä¸€UTCæ—¶é—´3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ11ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºæ‚¨è‡ªå·±çš„ä»“åº“
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½®Gitèº«ä»½
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 3. æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶æ‹‰å–æ›´æ–°
      - name: Add and Fetch Upstream
        run: |
          git remote add upstream https://github.com/sansan0/TrendRadar.git 2>/dev/null || true
          git fetch upstream --force
          echo "âœ… å·²æ‹‰å–ä¸Šæ¸¸ä»“åº“ (sansan0/TrendRadar) çš„æ›´æ–°ã€‚"

      # 4. åŸºäºä¸Šæ¸¸çš„ master åˆ†æ”¯åˆ›å»ºåŒæ­¥åˆ†æ”¯
      - name: Create Branch from Upstream Master
        id: create-branch
        run: |
          # ç¡®è®¤ä¸Šæ¸¸ master åˆ†æ”¯å­˜åœ¨
          if ! git show-ref --verify --quiet refs/remotes/upstream/master; then
            echo "âŒ é”™è¯¯ï¼šä¸Šæ¸¸ä»“åº“ä¸­æœªæ‰¾åˆ° 'master' åˆ†æ”¯ã€‚"
            exit 1
          fi
          # åˆ›å»ºå”¯ä¸€çš„åŒæ­¥åˆ†æ”¯å
          SYNC_BRANCH="sync/upstream-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$SYNC_BRANCH" upstream/master --no-track
          echo "âœ… å·²åˆ›å»ºåŒæ­¥åˆ†æ”¯: $SYNC_BRANCH"
          # å°†åˆ†æ”¯åè®¾ç½®ä¸ºè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "branch-name=$SYNC_BRANCH" >> $GITHUB_OUTPUT

      # 5. æ¢å¤æ‚¨éœ€è¦ä¿æŠ¤çš„æ–‡ä»¶ (ä»æ‚¨è‡ªå·±ä»“åº“çš„ã€ä¸»åˆ†æ”¯ã€‘)
      - name: Restore Protected Files
        run: |
          # ã€é‡è¦ã€‘è¯·å°† `master` æ”¹ä¸ºæ‚¨è‡ªå·± AI-Rader ä»“åº“çš„ä¸»åˆ†æ”¯å (å¯èƒ½æ˜¯ main)
          YOUR_BASE_BRANCH="master"
          echo "æ­£åœ¨ä» origin/$YOUR_BASE_BRANCH æ¢å¤å—ä¿æŠ¤æ–‡ä»¶..."
          # å°è¯•æ¢å¤æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™å¿½ç•¥
          if git checkout "origin/$YOUR_BASE_BRANCH" -- config.yaml 2>/dev/null; then
            echo "  å·²æ¢å¤ config.yaml"
          fi
          if git checkout "origin/$YOUR_BASE_BRANCH" -- frequency_words.txt 2>/dev/null; then
            echo "  å·²æ¢å¤ frequency_words.txt"
          fi
          # å¦‚æœæœ‰æ–‡ä»¶è¢«æ›´æ”¹ï¼Œåˆ™æäº¤
          if ! git diff --staged --quiet && git add config.yaml frequency_words.txt; then
            git commit -m "chore(sync): restore protected files from origin/$YOUR_BASE_BRANCH"
            echo "âœ… å·²æäº¤æ–‡ä»¶æ¢å¤ã€‚"
          else
            echo "â„¹ï¸  å—ä¿æŠ¤æ–‡ä»¶æ— æ›´æ”¹ï¼Œæ— éœ€æäº¤ã€‚"
          fi

      # 6. åˆ›å»º Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync updates from upstream TrendRadar"
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ï¼šä¸Šæ¸¸ TrendRadar æ›´æ–° [$(date +%Y-%m-%d)]"
          body: |
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«æ¥è‡ªä¸Šæ¸¸ä»“åº“ [sansan0/TrendRadar](https://github.com/sansan0/TrendRadar) çš„æ›´æ–°ã€‚

            **å·²ä¿æŠ¤ä»¥ä¸‹æ–‡ä»¶ (æ‚¨çš„æœ¬åœ°ç‰ˆæœ¬è¢«ä¿ç•™):**
            - `config.yaml`
            - `frequency_words.txt`

            è¯·æ£€æŸ¥å…¶ä»–æ–‡ä»¶çš„å˜æ›´ï¼Œç¡®è®¤æ— è¯¯ååˆå¹¶ã€‚
          # æºåˆ†æ”¯ï¼šä½¿ç”¨ä¸Šä¸€æ­¥åˆ›å»ºçš„åˆ†æ”¯
          branch: ${{ steps.create-branch.outputs.branch-name }}
          # ã€é‡è¦ã€‘ç›®æ ‡åˆ†æ”¯ï¼šå¿…é¡»æ”¹ä¸ºæ‚¨ AI-Rader ä»“åº“çš„ä¸»åˆ†æ”¯å
          base: master
          labels: automated-pr, upstream-sync
          delete-branch: true
          # å¦‚æœæ²¡æœ‰ä»»ä½•æ–‡ä»¶å˜æ›´ï¼Œåˆ™è·³è¿‡åˆ›å»ºPRï¼ˆé™é»˜æˆåŠŸï¼‰
         # skip-if-empty: true
