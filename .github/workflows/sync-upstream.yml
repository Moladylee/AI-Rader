name: Sync Upstream via PR
on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1' # æ¯å‘¨ä¸€ UTC 3ç‚¹è‡ªåŠ¨æ£€æŸ¥

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          # ä»…æ‹‰å–æ‚¨è‡ªå·±ä»“åº“çš„ä»£ç 
          fetch-depth: 0

      - name: Restore Protected Files (Prepare)
        # å…ˆå¤‡ä»½æ‚¨è¦ä¿æŠ¤çš„æ–‡ä»¶ï¼è¿™æ˜¯å…³é”®ã€‚
        run: |
          mkdir -p /tmp/protected_files_backup
          cp -f ./config.yaml /tmp/protected_files_backup/ 2>/dev/null || echo "config.yaml not found in base."
          cp -f ./frequency_words.txt /tmp/protected_files_backup/ 2>/dev/null || echo "frequency_words.txt not found in base."

      - name: Create Pull Request with Upstream Updates
        uses: peter-evans/create-pull-request@v5
        id: pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # ã€é‡è¦ã€‘æŒ‡å®šä¸Šæ¸¸ä»“åº“ä½œä¸ºé¢å¤–çš„è¿œç¨‹ä»“åº“æ¥æ‹‰å–æ›´æ–°
          repository: Moladylee/AI-Rader # æ‚¨è‡ªå·±çš„ä»“åº“
          upstream-repository: sansan0/TrendRadar # ä¸Šæ¸¸ä»“åº“
          upstream-branch: master # ä¸Šæ¸¸ä»“åº“çš„åˆ†æ”¯å
          # åˆ›å»ºPRçš„åˆ†æ”¯è®¾ç½®
          branch: auto-sync/trendradar # ç”¨äºPRçš„å›ºå®šåˆ†æ”¯åï¼Œè‡ªåŠ¨åˆ›å»º
          base: master # PRçš„ç›®æ ‡åˆ†æ”¯ï¼ˆæ‚¨ä»“åº“çš„ä¸»åˆ†æ”¯ï¼‰
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ï¼šä¸Šæ¸¸ TrendRadar æ›´æ–° [$(date +%Y-%m-%d)]"
          body: |
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«æ¥è‡ªä¸Šæ¸¸ä»“åº“ [sansan0/TrendRadar](https://github.com/sansan0/TrendRadar) çš„æ›´æ–°ã€‚

            **å·²ä¿æŠ¤ä»¥ä¸‹æ–‡ä»¶ (æ‚¨çš„æœ¬åœ°ç‰ˆæœ¬è¢«ä¿ç•™):**
            - `config.yaml`
            - `frequency_words.txt`

            è¯·æ£€æŸ¥å…¶ä»–æ–‡ä»¶çš„å˜æ›´ï¼Œç¡®è®¤æ— è¯¯ååˆå¹¶ã€‚
          commit-message: "chore: sync updates from upstream TrendRadar"
          labels: automated-pr, upstream-sync
          delete-branch: true # åˆå¹¶ååˆ é™¤ä¸´æ—¶åˆ†æ”¯
          # è¿™ä¸ªå¼€å…³ç¡®ä¿å³ä½¿ä¸Šæ¸¸æ— æ›´æ–°ï¼Œå·¥ä½œæµä¹ŸæˆåŠŸï¼ˆä¸åˆ›å»ºç©ºPRï¼‰
          skip-no-changes: true

      - name: Restore Protected Files (Final)
        # åœ¨ PR åˆ†æ”¯åˆ›å»ºåï¼Œè¦†ç›–æ‰æ¥è‡ªä¸Šæ¸¸çš„é…ç½®æ–‡ä»¶ã€‚
        if: steps.pr.outputs.pull-request-operation == 'created'
        run: |
          echo "æ­£åœ¨æ¢å¤å—ä¿æŠ¤çš„æ–‡ä»¶..."
          # åˆ‡æ¢åˆ°Actionåˆšåˆšåˆ›å»ºçš„PRåˆ†æ”¯
          git fetch origin
          git checkout auto-sync/trendradar
          # ç”¨æˆ‘ä»¬æœ€åˆå¤‡ä»½çš„ç‰ˆæœ¬è¦†ç›–æ–‡ä»¶
          cp -f /tmp/protected_files_backup/config.yaml ./ 2>/dev/null || echo "No config.yaml backup to restore."
          cp -f /tmp/protected_files_backup/frequency_words.txt ./ 2>/dev/null || echo "No frequency_words.txt backup to restore."
          # æäº¤æ›´æ”¹
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add config.yaml frequency_words.txt
          # åªæœ‰å½“æ–‡ä»¶å®é™…æœ‰å˜åŒ–æ—¶æ‰æäº¤
          if ! git diff --cached --quiet; then
            git commit -m "chore: restore protected config files from base branch"
            git push
            echo "âœ… å—ä¿æŠ¤æ–‡ä»¶å·²æ¢å¤å¹¶æ¨é€ã€‚"
          else
            echo "â„¹ï¸ å—ä¿æŠ¤æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          fi
