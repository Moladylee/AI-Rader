name: Sync Upstream via PR
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 8 * * *' # æ¯å‘¨ä¸€UTCæ—¶é—´3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ11ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Your Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´å†å²ï¼Œä¾¿äºæ¯”è¾ƒ

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch Upstream Changes
        run: |
          git remote add upstream https://github.com/sansan0/TrendRadar.git 2>/dev/null || true
          git fetch upstream

      - name: Create a New Branch with Upstream Code
        run: |
          # åŸºäºä¸Šæ¸¸æœ€æ–°ä»£ç åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ä¸´æ—¶åˆ†æ”¯
          git checkout -b sync/upstream-$(date +%s) upstream/master --no-track
          echo "å·²åŸºäºä¸Šæ¸¸ä»£ç åˆ›å»ºåˆ†æ”¯: $(git branch --show-current)"

      - name: Restore Your Protected Files
        run: |
          # å…³é”®æ­¥éª¤ï¼šç”¨æ‚¨è‡ªå·±ä»“åº“ä¸»åˆ†æ”¯çš„ç‰ˆæœ¬ï¼Œè¦†ç›–ä¸´æ—¶åˆ†æ”¯ä¸­çš„é…ç½®æ–‡ä»¶
          # è¿™ç¡®ä¿äº†æ‚¨çš„ config.yaml å’Œ frequency_words.txt æ°¸è¿œä¸ä¼šè¢«ä¸Šæ¸¸è¦†ç›–
          git checkout origin/master -- config.yaml frequency_words.txt 2>/dev/null || echo "æ³¨æ„ï¼šæœªæ‰¾åˆ°éƒ¨åˆ†æ–‡ä»¶ï¼Œå°†ç»§ç»­ã€‚"
          # å¦‚æœæœ‰æ›´æ”¹ï¼Œåˆ™æäº¤
          if ! git diff --cached --quiet && git add config.yaml frequency_words.txt; then
            git commit -m "chore: restore protected config files (config.yaml, frequency_words.txt)"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync updates from upstream TrendRadar"
          title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ï¼šä¸Šæ¸¸ TrendRadar æ›´æ–°"
          body: |
            æ­¤ Pull Request ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«æ¥è‡ªä¸Šæ¸¸ä»“åº“ [sansan0/TrendRadar](https://github.com/sansan0/TrendRadar) çš„æ›´æ–°ã€‚

            **æœ¬æ¬¡åŒæ­¥å·²ä¿æŠ¤ä»¥ä¸‹æ–‡ä»¶ï¼Œæ‚¨çš„ä¿®æ”¹å°†è¢«ä¿ç•™ï¼š**
            - `config.yaml`
            - `frequency_words.txt`

            è¯·ä»”ç»†æ£€æŸ¥å…¶ä»–æ–‡ä»¶çš„å˜æ›´ï¼Œç¡®è®¤æ— è¯¯ååˆå¹¶æ­¤PRã€‚
          branch: "auto-sync/trendradar" # ç”¨äºåˆ›å»ºPRçš„ä¸´æ—¶åˆ†æ”¯
          base: master # ç›®æ ‡åˆ†æ”¯ï¼ˆè¯·ç¡®è®¤æ‚¨çš„ä¸»åˆ†æ”¯åæ˜¯ master è¿˜æ˜¯ mainï¼‰
          delete-branch: true # PRåˆå¹¶åè‡ªåŠ¨åˆ é™¤ä¸´æ—¶åˆ†æ”¯
